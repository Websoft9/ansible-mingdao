- name: Create a directory if it does not exist
  file:
    path: /usr/local/mingdao
    state: directory
    
- name: Create a file as the identity file
  shell: touch /usr/local/mingdao/first
    
- name: Pull mingdao docker image & change tag
  shell: |
    docker pull mdpublic/mingdaoyun-community
    docker pull mdpublic/mingdaoyun-doc
    docker tag mdpublic/mingdaoyun-community:latest registry.cn-hangzhou.aliyuncs.com/mdpublic/mingdaoyun-community:1.0.0
    docker rmi mdpublic/mingdaoyun-community:latest
    docker tag mdpublic/mingdaoyun-doc:latest registry.cn-hangzhou.aliyuncs.com/mdpublic/mingdaoyun-doc:1.0.0
    docker rmi mdpublic/mingdaoyun-doc:latest
  
- name: Download mingdao installation tool from {{mingdao_download_url}}
  shell: |
    curl {{mingdao_download_url}} | tar xvz -C /usr/local/mingdao
    bash /usr/local/mingdao/service.sh start
  args:
    chdir: /tmp

- name: add startup scripts sys.sh to Server
  template:
    src: sys.sh
    dest: /usr/local/mingdao

- name: add sys.sh to /etc/rc.local
  shell: |
    echo '#!/bin/bash' > /etc/rc.local
    echo '/bin/bash /usr/local/mingdao/sys.sh > /usr/local/mingdao/service.log 2>&1' >> /etc/rc.local
    chmod 755 /etc/rc.local
